/**
 * AULA F87 HID Protocol — constants, templates, and key layout.
 * Ported from the Python CLI and original webapp.
 */

// ── USB Identifiers ─────────────────────────────────────────────────────
export const WIRED_VID = 0x258A;
export const WIRED_PID = 0x010C;
export const WIRELESS_VID = 0x3554;
export const WIRELESS_PID = 0xFA09;

// ── Report / command bytes ──────────────────────────────────────────────
export const REPORT_ID = 0x13;
export const CMD_READ = 0x44;
export const CMD_WRITE = 0x04;
export const CMD_COLOR = 0x09;
export const CMD_PERKEY = 0x02;
export const CMD_SAVE = 0x0A;
export const SUBCMD_CONFIG = 0x0A;
export const SUBCMD_PALETTE = 0x25;
export const SUBCMD_PERKEY = 0x1C;
export const SUBCMD_CONFIRM = 0x01;
export const SELF_DEFINE_EFFECT = 21;

// ── Effects ─────────────────────────────────────────────────────────────
export interface Effect {
    name: string;
    speed: boolean;
    color: boolean;
}

export const EFFECTS: Record<number, Effect> = {
    1: { name: "Fixed on", speed: false, color: true },
    2: { name: "Respire", speed: true, color: true },
    3: { name: "Rainbow", speed: true, color: false },
    4: { name: "Flash away", speed: true, color: true },
    5: { name: "Raindrops", speed: true, color: true },
    6: { name: "Rainbow wheel", speed: true, color: true },
    7: { name: "Ripples shining", speed: true, color: true },
    8: { name: "Stars twinkle", speed: true, color: true },
    9: { name: "Shadow disappear", speed: true, color: true },
    10: { name: "Retro snake", speed: true, color: true },
    11: { name: "Neon stream", speed: true, color: true },
    12: { name: "Reaction", speed: true, color: true },
    13: { name: "Sine wave", speed: true, color: true },
    14: { name: "Retinue scanning", speed: true, color: true },
    15: { name: "Rotating windmill", speed: true, color: false },
    16: { name: "Colorful waterfall", speed: true, color: false },
    17: { name: "Blossoming", speed: true, color: false },
    18: { name: "Rotating storm", speed: true, color: true },
};

// ── Config template (10 × 15-byte payloads) ─────────────────────────────
export const CFG_TEMPLATE: number[][] = [
    [0x0e, 0x00, 0x03, 0x03, 0x01, 0x00, 0x00, 0x04, 0x04, 0x07, 0x00, 0x00, 0x20, 0x03, 0x00],
    [0x0e, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x02, 0x01, 0x00, 0xff, 0x0a, 0x00, 0x00, 0x00],
    [0x0e, 0x01, 0x00, 0x04, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
    [0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
    [0x0e, 0xff, 0xff, 0x04, 0x47, 0x04, 0x47, 0x04, 0x47, 0x04, 0x47, 0x04, 0x47, 0x04, 0x47],
    [0x0e, 0x04, 0x47, 0x04, 0x47, 0x04, 0x47, 0x04, 0x47, 0x04, 0x47, 0x04, 0x47, 0x04, 0x47],
    [0x0e, 0x04, 0x47, 0x04, 0x47, 0x04, 0x47, 0x04, 0x37, 0x04, 0x37, 0x04, 0x37, 0x04, 0x37],
    [0x0e, 0x07, 0x47, 0x07, 0x47, 0x07, 0x44, 0x07, 0x44, 0x07, 0x44, 0x07, 0x44, 0x07, 0x44],
    [0x0e, 0x07, 0x44, 0x07, 0x44, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04],
    [0x02, 0x5a, 0xa5, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
];

// ── Palette template (21 entries + zeros + last) ────────────────────────
export const PAL_TEMPLATE: number[][] = [
    [0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
    [0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00],
    [0x0e, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff],
    [0x0e, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00],
    [0x0e, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00],
    [0x0e, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff],
    [0x0e, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00],
    [0x0e, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00],
    [0x0e, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff],
    [0x0e, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00],
    [0x0e, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00],
    [0x0e, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff],
    [0x0e, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00],
    [0x0e, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00],
    [0x0e, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff],
    [0x0e, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00],
    [0x0e, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00],
    [0x0e, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff],
    [0x0e, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00],
    [0x0e, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00],
    [0x0e, 0x00, 0xff, 0xff, 0xff, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff],
];
export const PAL_ZEROS = [0x0e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00];
export const PAL_LAST = [0x08, 0x00, 0x00, 0x5a, 0xa5, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00];

// ── Key layout: [label, ledIndex, widthMultiplier] ──────────────────────
// Number = gap between key groups (in units)
export type KeyEntry = [string, number, number] | number;
export const KB_ROWS: KeyEntry[][] = [
    [['Esc', 0, 1], 1, ['F1', 12, 1], ['F2', 18, 1], ['F3', 24, 1], ['F4', 30, 1], 0.5, ['F5', 36, 1], ['F6', 42, 1], ['F7', 48, 1], ['F8', 54, 1], 0.5, ['F9', 60, 1], ['F10', 66, 1], ['F11', 72, 1], ['F12', 78, 1], 0.25, ['Prt', 84, 1], ['Scr', 90, 1], ['Pse', 96, 1]],
    [['`', 1, 1], ['1', 7, 1], ['2', 13, 1], ['3', 19, 1], ['4', 25, 1], ['5', 31, 1], ['6', 37, 1], ['7', 43, 1], ['8', 49, 1], ['9', 55, 1], ['0', 61, 1], ['-', 67, 1], ['=', 73, 1], ['Bksp', 79, 2], 0.25, ['Ins', 85, 1], ['Home', 91, 1], ['PgUp', 97, 1]],
    [['Tab', 2, 1.5], ['Q', 8, 1], ['W', 14, 1], ['E', 20, 1], ['R', 26, 1], ['T', 32, 1], ['Y', 38, 1], ['U', 44, 1], ['I', 50, 1], ['O', 56, 1], ['P', 62, 1], ['[', 68, 1], [']', 74, 1], ['\\', 80, 1.5], 0.25, ['Del', 86, 1], ['End', 92, 1], ['PgDn', 98, 1]],
    [['Caps', 3, 1.75], ['A', 9, 1], ['S', 15, 1], ['D', 21, 1], ['F', 27, 1], ['G', 33, 1], ['H', 39, 1], ['J', 45, 1], ['K', 51, 1], ['L', 57, 1], [';', 63, 1], ["'", 69, 1], ['Enter', 81, 2.25]],
    [['LShift', 4, 2.25], ['Z', 10, 1], ['X', 16, 1], ['C', 22, 1], ['V', 28, 1], ['B', 34, 1], ['N', 40, 1], ['M', 46, 1], [',', 52, 1], ['.', 58, 1], ['/', 64, 1], ['RShift', 82, 2.75], 1.25, ['↑', 94, 1]],
    [['Ctrl', 5, 1.25], ['Win', 11, 1.25], ['Alt', 17, 1.25], ['Space', 35, 6.25], ['Alt', 53, 1.25], ['Fn', 59, 1.25], ['App', 65, 1.25], ['Ctrl', 83, 1.25], 0.25, ['←', 89, 1], ['↓', 95, 1], ['→', 101, 1]],
];

// ── Helpers ─────────────────────────────────────────────────────────────
export function checksum(data: Uint8Array): number {
    let s = 0;
    for (let i = 0; i < 19; i++) s += data[i];
    return s & 0xff;
}

export function buildFrame(cmd: number, subcmd: number, seq: number, payload: number[] | Uint8Array): Uint8Array {
    const f = new Uint8Array(20);
    f[0] = REPORT_ID; f[1] = cmd; f[2] = subcmd; f[3] = seq;
    for (let i = 0; i < 15 && i < payload.length; i++) f[4 + i] = payload[i];
    f[19] = checksum(f);
    return f;
}

export function effectTableLoc(n: number): [number, number] {
    if (n >= 1 && n <= 6) return [4, 7 + (n - 1) * 2];
    if (n >= 7 && n <= 13) return [5, 5 + (n - 7) * 2];
    if (n >= 14 && n <= 18) return [6, 5 + (n - 14) * 2];
    return [4, 7];
}

export function encodeSpeedByte(speed: number, colorful: boolean): number {
    return (speed << 4) | (colorful ? 0x07 : 0x00);
}

export function decodeSpeedByte(b: number): { speed: number; colorful: boolean } {
    return { speed: (b >> 4) & 0xf, colorful: (b & 0xf) === 0x7 };
}

export function hex(buf: Uint8Array | ArrayBuffer): string {
    return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2, '0')).join('');
}

export function hexToRgb(h: string): [number, number, number] {
    const m = h.match(/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);
    return m ? [parseInt(m[1], 16), parseInt(m[2], 16), parseInt(m[3], 16)] : [255, 0, 0];
}

export function rgbToHex(r: number, g: number, b: number): string {
    return '#' + [r, g, b].map(c => c.toString(16).padStart(2, '0')).join('');
}
